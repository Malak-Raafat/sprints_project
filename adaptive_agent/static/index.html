<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Adaptive Research Innovation Agent</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }
    h1 {
      color: #222;
    }
    input, button {
      padding: 10px;
      margin: 10px 5px 10px 0;
      font-size: 16px;
    }
    .section {
      background: white;
      padding: 20px;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    pre {
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ§  Adaptive Research & Innovation Agent</h1>

  <div class="section">
    <label><strong>Enter a Topic:</strong></label><br>
    <input type="text" id="topic" value="AI" placeholder="e.g. quantum computing">
    <input type="number" id="maxResults" value="5" min="1" max="20">
    <br>
    <button onclick="handleButton('fetch-papers')">ğŸ“š Fetch Papers</button>
    <button onclick="handleButton('analyze')">ğŸ” Analyze Topic</button>
    <button onclick="handleButton('innovate')">ğŸš€ Innovate</button>
  </div>

  <div class="section" id="papersSection" style="display:none">
    <h2>ğŸ“„ Papers</h2>
    <div id="papers"></div>
  </div>

  <div class="section" id="keywordsSection" style="display:none">
    <h2>ğŸ”‘ Top Keywords</h2>
    <ul id="keywords"></ul>
  </div>

  <div class="section" id="proposalSection" style="display:none">
    <h2>ğŸ’¡ Innovation Proposal</h2>
    <pre id="proposal"></pre>

    <div id="downloadSection" style="margin-top: 15px;">
      <a href="/export-report" download>
        <button>ğŸ“¥ Download Proposal (Markdown)</button>
      </a>
    </div>
  </div>

  <div class="section" id="feedbackSection" style="display:none">
    <h2>ğŸ—³ï¸ Feedback</h2>
    <button onclick="sendFeedback(1)">ğŸ‘ Good</button>
    <button onclick="sendFeedback(-1)">ğŸ‘ Not Relevant</button>
    <div id="feedbackMessage" style="display:none; margin-top:10px; font-weight:bold;"></div>

  </div>

  <button onclick="window.location.href='/chat-ui'">ğŸ’¬ Open Chat Assistant</button>
  <button onclick="window.location.href='/logout'">ğŸšª Logout</button>

  <script>
    let lastProposalId = null;

    function showFeedbackMessage(msg, success = true) {
      const box = document.getElementById("feedbackMessage");
      box.textContent = msg;
      box.style.color = success ? "green" : "red";
      box.style.display = "block";

      // Hide after 3 seconds
      setTimeout(() => {
        box.style.display = "none";
      }, 3000);
    }

    function sendFeedback(rating) {
      if (!lastProposalId) {
        showFeedbackMessage("âŒ Proposal ID missing", false);
        return;
      }

      fetch("/feedback", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ proposal_id: lastProposalId, rating })
      }).then(res => {
        if (res.ok) showFeedbackMessage("âœ… Feedback submitted!");
        else showFeedbackMessage("âŒ Failed to submit feedback", false);
      });
    }


    fetch('/check-session')
      .then(res => {
        if (res.status !== 200) {
          window.location.href = "/login-page";
        }
      })
      .catch(() => {
        window.location.href = "/login-page";
      });

    const API_BASE = 'http://127.0.0.1:8000';

    async function handleButton(endpoint) {
      const topic = document.getElementById('topic').value.trim();
      const max = document.getElementById('maxResults').value;

      try {
        await fetch(`${API_BASE}/set-config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          credentials: 'include',
          body: `topic=${encodeURIComponent(topic)}&max_results=${max}`
        });

        const res = await fetch(`${API_BASE}/${endpoint}?topic=${encodeURIComponent(topic)}&max_results=${max}`, {
          credentials: "include"
        });

        const data = await res.json();

        // Reset all sections
        document.getElementById('papersSection').style.display = 'none';
        document.getElementById('keywordsSection').style.display = 'none';
        document.getElementById('proposalSection').style.display = 'none';
        document.getElementById('feedbackSection').style.display = 'none';

        if (endpoint === 'fetch-papers') {
          document.getElementById('papers').innerHTML = data.results.map(p =>
            `<b>${p.title}</b><br>${p.summary}<br><a href="${p.link}" target="_blank">View</a><br><hr>`
          ).join('');
          document.getElementById('papersSection').style.display = 'block';

        } else if (endpoint === 'analyze') {
          document.getElementById('keywords').innerHTML = data.top_keywords.map(k =>
            `<li>${k[0]} (${k[1]})</li>`
          ).join('');
          document.getElementById('keywordsSection').style.display = 'block';

        } else if (endpoint === 'innovate') {
          document.getElementById('proposal').textContent = data.proposal;
          document.getElementById('proposalSection').style.display = 'block';

          // âœ… Set lastProposalId and show feedback section
          lastProposalId = data.proposal_id;
          document.getElementById('feedbackSection').style.display = 'block';
        }

      } catch (err) {
        alert("âŒ Failed to fetch data");
        console.error(err);
      }
    }
  </script>
</body>
</html>
